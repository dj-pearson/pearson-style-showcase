# Comprehensive Deployment Guide

> ⚠️ **UPDATED 2025-12-20:** This project now uses **self-hosted Supabase** at `api.danpearson.net`.
> Some references to the old cloud Supabase (`qazhdcqvjppbbjxzvisp.supabase.co`) remain in this document for historical context.
>
> **Current Configuration:**
> - API/Database: `https://api.danpearson.net`
> - Edge Functions: `https://functions.danpearson.net`
>
> See `SUPABASE_MIGRATION_AUDIT.md` for complete migration details.

**Project:** Dan Pearson Style Showcase
**Platform:** Cloudflare Pages + Self-Hosted Supabase
**Last Updated:** 2025-12-20
**Node.js Version:** 18+ (Required for Cloudflare Pages)

---

## Table of Contents

1. [Build Configuration](#build-configuration)
2. [Cloudflare Pages Setup](#cloudflare-pages-setup)
3. [Supabase Configuration](#supabase-configuration)
4. [Environment Variables](#environment-variables)
5. [Database Setup](#database-setup)
6. [Domain & DNS](#domain--dns)
7. [Deployment Workflow](#deployment-workflow)
8. [Post-Deployment Verification](#post-deployment-verification)
9. [Troubleshooting](#troubleshooting)

---

## 1. Build Configuration

### 1.1 Vite Configuration

**File:** `/home/user/pearson-style-showcase/vite.config.ts`

The project uses Vite with React and TypeScript. Key build optimizations include:

```typescript
// Manual vendor chunking for optimal caching
manualChunks: {
  'three-vendor': ['three', '@react-three/fiber', '@react-three/drei'],
  'react-vendor': ['react', 'react-dom', 'react-router-dom'],
  'ui-vendor': ['@radix-ui/react-dialog', '@radix-ui/react-dropdown-menu', '@radix-ui/react-select'],
  'icons-vendor': ['lucide-react'],
  'markdown-vendor': ['react-markdown', 'remark-gfm', 'react-syntax-highlighter'],
  'charts-vendor': ['recharts'],
  'form-vendor': ['react-hook-form', '@hookform/resolvers', 'zod'],
}
```

**Build Settings:**
- **Target:** ES2020
- **Minifier:** esbuild
- **Chunk Size Warning Limit:** 1000KB
- **Source Maps:** Generated in development mode only
- **Host:** `::` (IPv6 loopback, required for some environments)
- **Port:** 8080 (development only)

### 1.2 Build Scripts

**File:** `/home/user/pearson-style-showcase/package.json`

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "build:dev": "vite build --mode development",
    "build:pages": "npm ci --only=production && vite build",
    "lint": "eslint .",
    "preview": "vite preview",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  }
}
```

**Important:** 
- `npm run build` is the production build command
- `npm run build:pages` is optimized for Cloudflare Pages (installs production dependencies only)
- Output directory: `dist/` (configured in Cloudflare Pages)

### 1.3 Package Manager Configuration

**File:** `/home/user/pearson-style-showcase/.npmrc`

```ini
engine-strict=false
save-exact=true
optional=true
```

This configuration:
- Disables strict engine checking (fixes Cloudflare Pages build issues)
- Saves exact versions to avoid compatibility issues
- Allows optional dependencies (fixes Rollup binary issues)

### 1.4 Output Directory Structure

After `npm run build`, the `dist/` directory contains:

```
dist/
├── index.html              # Entry HTML with CSP headers
├── assets/
│   ├── main-[hash].js      # Main application bundle (~45KB gzipped)
│   ├── react-vendor-[hash].js    # React/Router bundle (~140KB gzipped)
│   ├── three-vendor-[hash].js    # Three.js bundle (~276KB gzipped, lazy-loaded)
│   ├── markdown-vendor-[hash].js # Markdown bundle (~277KB gzipped, lazy-loaded)
│   └── [other vendor chunks]
│   └── [hash].css          # Compiled Tailwind CSS
└── [static assets]
```

**Bundle Analysis:**
- Initial bundle: ~45KB (gzipped)
- Vendor chunks cached separately for optimal CDN caching
- Lazy-loaded route components reduce initial page load

---

## 2. Cloudflare Pages Setup

### 2.1 Wrangler Configuration

**File:** `/home/user/pearson-style-showcase/wrangler.toml`

```toml
name = "pearson-style-showcase"
pages_build_output_dir = "dist"
```

**Configuration Details:**
- **Project Name:** Must match Cloudflare Pages project
- **Output Directory:** `dist` (generated by Vite build)

### 2.2 Build Settings in Cloudflare Pages Dashboard

When connecting to Cloudflare Pages:

1. **Build Command:** 
   ```
   npm run build
   ```
   - Alternative for faster builds: `npm ci --only=production && vite build`

2. **Build Output Directory:** 
   ```
   dist
   ```

3. **Node.js Version:** 
   ```
   18
   ```
   - Required for the project's ESM modules and build tools
   - Set in Project Settings > Build Settings

4. **Environment Variables:**
   - No environment variables required for frontend deployment
   - Supabase keys are public and embedded in code

### 2.3 Redirects Configuration

**File:** `/home/user/pearson-style-showcase/public/_redirects`

```
/*    /index.html   200
```

**Purpose:**
- Enables client-side routing for React Router
- All requests to non-existent files return `index.html`
- HTTP status 200 (not 301/302) for SPA routing

### 2.4 HTTP Headers Configuration

**File:** `/home/user/pearson-style-showcase/public/_headers`

```
# Cache static assets for 1 year (immutable content-hash based assets)
/assets/*
  Cache-Control: public, max-age=31536000, immutable
  X-Content-Type-Options: nosniff

# Cache JavaScript and CSS with stale-while-revalidate
/assets/*.js
  Cache-Control: public, max-age=31536000, immutable, stale-while-revalidate=604800

/assets/*.css
  Cache-Control: public, max-age=31536000, immutable, stale-while-revalidate=604800

# Cache images for 1 week
/*.png
  Cache-Control: public, max-age=604800, s-maxage=604800, stale-while-revalidate=86400

/*.jpg
  Cache-Control: public, max-age=604800, s-maxage=604800, stale-while-revalidate=86400

# Don't cache HTML (ensures fresh content on deployments)
/*.html
  Cache-Control: public, max-age=0, must-revalidate

# Cache fonts permanently
/*.woff
  Cache-Control: public, max-age=31536000, immutable

/*.woff2
  Cache-Control: public, max-age=31536000, immutable

# Security headers for all responses
/*
  X-Frame-Options: DENY
  X-Content-Type-Options: nosniff
  Referrer-Policy: strict-origin-when-cross-origin
  Permissions-Policy: geolocation=(), microphone=(), camera=(), payment=(), usb=()
  X-XSS-Protection: 1; mode=block
```

**Caching Strategy:**
- Static assets (with content hash): 1 year
- HTML files: No caching (must-revalidate)
- Fonts: 1 year (immutable)
- Images: 1 week with stale-while-revalidate for resilience

### 2.5 Content Security Policy (CSP)

**File:** `/home/user/pearson-style-showcase/index.html`

```html
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com data:;
  img-src 'self' data: https: blob:;
  connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://www.googletagmanager.com;
  frame-src 'none';
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
  upgrade-insecure-requests;
">
```

**Key Restrictions:**
- No external scripts (except Google Analytics)
- Supabase API calls allowed via `connect-src`
- Frames disabled for security
- Insecure requests upgraded to HTTPS

---

## 3. Supabase Configuration

### 3.1 Supabase Project Details

**Project ID:** `qazhdcqvjppbbjxzvisp`  
**API URL:** `https://qazhdcqvjppbbjxzvisp.supabase.co`

**File:** `/home/user/pearson-style-showcase/supabase/config.toml`

```toml
project_id = "qazhdcqvjppbbjxzvisp"

[api]
enabled = true
port = 54321
schemas = ["public", "storage", "graphql_public"]

[db]
port = 54322
major_version = 15

[realtime]
enabled = true

[auth]
enabled = true
site_url = "http://127.0.0.1:3000"
jwt_expiry = 3600
enable_refresh_token_rotation = true
enable_signup = true
enable_anonymous_sign_ins = false
```

### 3.2 Edge Functions

The project includes 11 Supabase Edge Functions (deployed as Deno functions):

**Location:** `/home/user/pearson-style-showcase/supabase/functions/`

#### 3.2.1 Core Functions

| Function | Purpose | JWT Required | Key Environment Variables |
|----------|---------|--------------|---------------------------|
| `admin-auth` | Admin authentication with rate limiting | No | `ALLOWED_ORIGIN` |
| `send-contact-email` | Process contact form submissions | No | `RESEND_API` |
| `newsletter-signup` | Handle newsletter subscriptions | No | - |
| `track-affiliate-click` | Track affiliate link clicks | No | `SUPABASE_URL`, `SUPABASE_ANON_KEY` |

#### 3.2.2 AI & Content Functions

| Function | Purpose | JWT Required | Key Environment Variables |
|----------|---------|--------------|---------------------------|
| `generate-ai-article` | Generate articles using AI | Yes | `LOVABLE_API_KEY`, `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` |
| `ai-content-generator` | Generate various content types | Yes | `OPENAI_API` |
| `generate-social-content` | Create social media content | Yes | `LOVABLE_API_KEY` |

#### 3.2.3 Amazon Integration Functions

| Function | Purpose | JWT Required | Key Environment Variables |
|----------|---------|--------------|---------------------------|
| `amazon-article-pipeline` | Full Amazon affiliate content pipeline | No | `SERPAPI_KEY`, `GOOGLE_SEARCH_API_KEY`, `GOOGLE_SEARCH_ENGINE_ID`, `LOVABLE_API_KEY` |
| `send-article-webhook` | Process article webhooks | Yes | `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` |

#### 3.2.4 System Functions

| Function | Purpose | JWT Required | Key Environment Variables |
|----------|---------|--------------|---------------------------|
| `maintenance-runner` | Run scheduled maintenance tasks | Yes | `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` |
| `test-api-setup` | Test API configurations | No | Multiple (see details below) |

### 3.3 Function Deployment

**Deploying a Single Function:**

```bash
# Deploy a specific function
supabase functions deploy function-name

# Example
supabase functions deploy generate-ai-article
```

**Deploying All Functions:**

```bash
supabase functions deploy
```

**Function Configuration:**

Edit `/home/user/pearson-style-showcase/supabase/config.toml` to set JWT verification:

```toml
[functions.generate-ai-article]
verify_jwt = true

[functions.admin-auth]
verify_jwt = false

[functions.send-contact-email]
verify_jwt = false
```

### 3.4 Supabase Authentication Setup

**JWT Configuration:**
- Expiry: 3600 seconds (1 hour)
- Refresh token rotation: Enabled
- Signup: Enabled
- Anonymous signups: Disabled
- Manual linking: Disabled

**Email Configuration:**
- Signup enabled
- Double confirm changes enabled
- Confirmations disabled (auto-confirm on signup)

---

## 4. Environment Variables

### 4.1 Frontend Environment Variables

**File:** `/home/user/pearson-style-showcase/.env`

```env
# Supabase Configuration (PUBLIC - exposed to client)
VITE_SUPABASE_URL=https://qazhdcqvjppbbjxzvisp.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhemhkY3F2anBwYmJqeHp2aXNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTM5NzEsImV4cCI6MjA2ODA4OTk3MX0.-axZYOX3tBQDUy2EWuG5kNvswOc4iRq0QMFcGkQeRlM

# Optional: Google Analytics
VITE_GA_MEASUREMENT_ID=G-8R95ZXMV6L
```

**Important Notes:**
- Variables prefixed with `VITE_` are exposed to the browser
- These are PUBLIC keys (anon role, not service role)
- Safe to commit to version control
- Referenced in: `/home/user/pearson-style-showcase/src/integrations/supabase/client.ts`

### 4.2 Backend Environment Variables (Supabase Edge Functions)

Deploy these as Supabase secrets:

```bash
supabase secrets set SUPABASE_URL=https://qazhdcqvjppbbjxzvisp.supabase.co
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
supabase secrets set SUPABASE_ANON_KEY=your-anon-key-here
```

#### Required for All Functions
- `SUPABASE_URL` - Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY` - Service role key for database access (secret - never expose)

#### API Integration Variables

| Variable | Function(s) | Purpose |
|----------|-----------|---------|
| `OPENAI_API` | `ai-content-generator` | OpenAI API key for GPT-4 |
| `LOVABLE_API_KEY` | `generate-ai-article`, `generate-social-content`, `amazon-article-pipeline` | Lovable/Cursor AI API |
| `SERPAPI_KEY` | `amazon-article-pipeline`, `test-api-setup` | SerpAPI for Google search |
| `GOOGLE_SEARCH_API_KEY` | `amazon-article-pipeline`, `test-api-setup` | Google Custom Search API |
| `GOOGLE_SEARCH_ENGINE_ID` | `amazon-article-pipeline`, `test-api-setup` | Google Search Engine ID |
| `RESEND_API` | `send-contact-email` | Resend email service API |
| `DATAFORSEO_API_LOGIN` | `test-api-setup` | DataForSEO API login |
| `DATAFORSEO_API_PASSWORD` | `test-api-setup` | DataForSEO API password |
| `ALLOWED_ORIGIN` | `admin-auth` | CORS origin for admin functions |

### 4.3 Setting Environment Variables

**For Local Development:**

```bash
# Copy template
cp .env.example .env

# Edit with your values
nano .env

# Verify they're loaded
echo $VITE_SUPABASE_URL
```

**For Cloudflare Pages:**

No frontend environment variables needed - Supabase keys are embedded in the code.

**For Supabase Edge Functions:**

```bash
# Set individual secret
supabase secrets set OPENAI_API=sk-...

# List all secrets
supabase secrets list

# Delete a secret
supabase secrets unset OPENAI_API
```

---

## 5. Database Setup

### 5.1 Database Migrations Overview

**Location:** `/home/user/pearson-style-showcase/supabase/migrations/`

The project has 25 migration files totaling ~2,391 lines of SQL:

#### Migration Timeline

| Date | Migration | Purpose |
|------|-----------|---------|
| 2025-07-16 | Initial Schema | Projects, basic setup |
| 2025-07-17 | Articles System | Article management, publishing |
| 2025-10-07 | Admin System | Admin users, authentication |
| 2025-10-14 | Enhancement | Performance and features |
| 2025-10-31 | Advanced Features | Extended functionality |
| 2025-11-06 | Enhancement Suite | Additional features |
| 2025-11-08 | Command Center | System monitoring, alerts |
| 2025-11-08 | Support Tickets | Ticketing system |
| 2025-11-08 | Maintenance | Scheduled maintenance |
| 2025-11-10 | Testimonials & Profile | Social proof, profile settings |

### 5.2 Core Tables

#### Projects Table
```sql
CREATE TABLE public.projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  image_url TEXT,
  tags TEXT[] DEFAULT '{}',
  status TEXT DEFAULT 'Active',
  featured BOOLEAN DEFAULT false,
  github_link TEXT,
  live_link TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

#### Articles Table
- Full-featured CMS with content management
- SEO metadata support
- Multiple status workflows (draft/published/archived)
- RLS policies for access control

#### Admin Users Table
- User authentication and authorization
- Admin role management
- Access control for sensitive operations

#### Testimonials Table
```sql
CREATE TABLE public.testimonials (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_name TEXT NOT NULL,
  client_title TEXT,
  client_company TEXT,
  client_photo_url TEXT,
  testimonial_text TEXT NOT NULL,
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  featured BOOLEAN DEFAULT false,
  status TEXT DEFAULT 'published'
);
```

#### Profile Settings Table
```sql
CREATE TABLE public.profile_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_photo_url TEXT,
  hero_tagline TEXT,
  availability_status TEXT DEFAULT 'available',
  calendly_url TEXT,
  resume_url TEXT,
  linkedin_url TEXT DEFAULT 'https://www.linkedin.com/in/danpearson',
  github_url TEXT DEFAULT 'https://github.com/danpearson',
  email TEXT DEFAULT 'dan@danpearson.net'
);
```

#### Ventures Table
```sql
CREATE TABLE public.ventures (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  tagline TEXT,
  description TEXT,
  logo_url TEXT,
  tech_stack TEXT[],
  status TEXT DEFAULT 'in-development',
  live_url TEXT,
  github_url TEXT,
  featured BOOLEAN DEFAULT false
);
```

#### Support Tickets Table
```sql
CREATE TABLE public.support_tickets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ticket_number TEXT UNIQUE NOT NULL,
  subject TEXT NOT NULL,
  message TEXT NOT NULL,
  category TEXT,
  priority INTEGER DEFAULT 2,
  status TEXT DEFAULT 'open',
  ai_suggested_responses JSONB,
  ai_sentiment_score NUMERIC
);
```

#### Maintenance Tables
- `maintenance_tasks` - Scheduled maintenance configuration
- `maintenance_results` - Execution history and results
- `link_health` - Broken link detection and tracking
- `performance_history` - Core Web Vitals tracking

#### Command Center Tables
- `system_metrics` - Performance and error tracking
- `alert_rules` - Alert configuration and thresholds
- `admin_activity_log` - Audit trail of admin actions

### 5.3 Row Level Security (RLS) Policies

All tables have RLS enabled with specific policies:

**Example: Public Read, Admin Write Pattern**

```sql
-- Public read access
CREATE POLICY "Allow public read access to testimonials"
  ON public.testimonials
  FOR SELECT
  USING (status = 'published');

-- Admin write access
CREATE POLICY "Allow admin full access to testimonials"
  ON public.testimonials
  FOR ALL
  USING (auth.jwt() ->> 'role' = 'admin' OR EXISTS (
    SELECT 1 FROM admin_users WHERE id = auth.uid()
  ));
```

### 5.4 Running Migrations

**Automatic (Recommended):**

Migrations run automatically when you deploy to Supabase:

```bash
# Deploy all migrations
supabase db push

# With confirmation
supabase db push --dry-run  # See what will be applied
```

**Manual Application:**

```bash
# Connect to your Supabase database
psql -h db.project-ref.supabase.co -U postgres -d postgres

# Run individual SQL files
\i /path/to/migration/20251110000001_testimonials_and_profile.sql
```

### 5.5 Database Initialization Checklist

- [ ] All 25 migrations applied successfully
- [ ] RLS policies enabled on all tables
- [ ] Admin user account created
- [ ] Initial profile settings inserted
- [ ] Sample testimonials added (optional)
- [ ] Test data loaded (if needed)

---

## 6. Domain & DNS

### 6.1 Domain Configuration

**Primary Domain:** `danpearson.net`

**Current Configuration:**
- Hosted on Cloudflare Pages
- HTTPS enforced
- No www subdomain

### 6.2 Robots.txt Configuration

**File:** `/home/user/pearson-style-showcase/public/robots.txt`

```
User-agent: *
Allow: /

# Block date archives and admin routes
Disallow: /admin/
Disallow: /2023/
Disallow: /2025/
Disallow: /*?ref=*

# Sitemap location
Sitemap: https://danpearson.net/sitemap.xml
```

### 6.3 DNS Setup for Cloudflare Pages

1. **Add site to Cloudflare:**
   - Log in to Cloudflare dashboard
   - Add site → danpearson.net
   - Update nameservers at domain registrar

2. **Create Pages Project:**
   - Pages > Create a project
   - Connect GitHub repository
   - Authorize Cloudflare to access repository

3. **Configure Build Settings:**
   ```
   Framework: None (Custom)
   Build command: npm run build
   Build output directory: dist
   Root directory: /
   ```

4. **Add Custom Domain:**
   - Pages > Settings > Custom domains
   - Add danpearson.net
   - Cloudflare manages DNS automatically

### 6.4 DNS Records

Cloudflare manages these automatically:

```
Type   Name              Content              TTL
A      danpearson.net    104.21.x.x.x         Auto
CNAME  www               danpearson.net       Auto
MX     danpearson.net    (Cloudflare managed) Auto
```

### 6.5 SEO Configuration

**Canonical URL:** All pages set `<link rel="canonical" href="https://danpearson.net/..." />`

**Content Security Policy:** Configured in `index.html` (see Section 2.5)

**Open Graph Tags:** Configured for social media sharing

---

## 7. Deployment Workflow

### 7.1 Pre-Deployment Checklist

```bash
# 1. Verify environment variables
echo $VITE_SUPABASE_URL
echo $VITE_SUPABASE_PUBLISHABLE_KEY

# 2. Run linter
npm run lint

# 3. Run tests (if available)
npm run test

# 4. Build locally
npm run build

# 5. Preview build
npm run preview

# 6. Check build output size
du -sh dist/
ls -lh dist/assets/
```

### 7.2 Automated Deployment (Cloudflare Pages)

**Trigger:** Push to main branch or selected branch

**Process:**
1. Cloudflare detects repository push
2. Clones repository
3. Installs dependencies: `npm ci`
4. Runs build: `npm run build`
5. Uploads `dist/` directory
6. Publishes to CDN
7. Invalidates cache

**Build Logs:** Available in Cloudflare Pages dashboard > Deployments

### 7.3 Manual Deployment

```bash
# Only if automated deployment fails

# Build locally
npm run build

# Deploy using Wrangler CLI
npm install -g wrangler

# Login to Cloudflare
wrangler login

# Deploy pages project
wrangler pages deploy dist/ --project-name=pearson-style-showcase
```

### 7.4 Supabase Deployment

**Deploy Database Migrations:**

```bash
# Install Supabase CLI
npm install -g supabase

# Login
supabase login

# Link to project
supabase link --project-id qazhdcqvjppbbjxzvisp

# Deploy migrations
supabase db push

# Verify status
supabase db status
```

**Deploy Edge Functions:**

```bash
# Deploy all functions
supabase functions deploy

# Deploy specific function
supabase functions deploy admin-auth

# Set secrets before deploying
supabase secrets set SUPABASE_URL=https://qazhdcqvjppbbjxzvisp.supabase.co
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your-key-here
supabase secrets set OPENAI_API=your-key-here
# ... etc for all functions

# Redeploy after setting secrets
supabase functions deploy
```

### 7.5 Deployment Order

1. **Supabase Database:** Apply migrations first
2. **Supabase Functions:** Deploy with all secrets configured
3. **Frontend:** Deploy to Cloudflare Pages

**Why this order:**
- Database must exist for functions to work
- Functions must be deployed with secrets before frontend calls them
- Frontend can then safely call the API

---

## 8. Post-Deployment Verification

### 8.1 Frontend Verification

**Check Website Load:**
```bash
curl -I https://danpearson.net
# Expected: HTTP/2 200

# Check specific page
curl https://danpearson.net | grep -i "Dan Pearson"
```

**Verify Security Headers:**
```bash
curl -I https://danpearson.net | grep -E "X-Frame|X-Content|Referrer"
# Expected:
# X-Frame-Options: DENY
# X-Content-Type-Options: nosniff
# Referrer-Policy: strict-origin-when-cross-origin
```

**Check CSP Header:**
```bash
curl -I https://danpearson.net | grep "Content-Security-Policy"
```

**Verify Redirects:**
```bash
# SPA routing test
curl -I https://danpearson.net/admin/login
# Expected: HTTP/2 200 (not 404)

# All routes should return index.html
curl https://danpearson.net/admin/login | head -20 | grep -i "title"
```

### 8.2 Supabase Verification

**Test Database Connection:**
```bash
# From your application code
import { supabase } from '@/integrations/supabase/client'

const { data, error } = await supabase.from('projects').select()
console.log(data)  // Should return projects
```

**Verify Migrations:**
```bash
# Login to Supabase dashboard
# Go to SQL Editor
# Run: SELECT * FROM information_schema.tables WHERE table_schema = 'public'
# Should see all tables: projects, articles, testimonials, ventures, etc.
```

**Test Edge Function:**
```bash
# Test admin-auth function
curl -X POST https://qazhdcqvjppbbjxzvisp.supabase.co/functions/v1/admin-auth \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'
```

### 8.3 Performance Verification

**Lighthouse Audit:**
```bash
# Using Chrome DevTools or web.dev
# Target metrics:
# - LCP: < 2.5s (Good)
# - FID: < 100ms (Good)
# - CLS: < 0.1 (Good)
```

**Bundle Size Check:**
```bash
npm run build

# Main bundle should be < 50KB gzipped
gzip -c dist/assets/main-*.js | wc -c

# All bundles combined should be < 1MB
du -sh dist/assets/
```

**Cache Verification:**
```bash
# Check 1-year cache on assets
curl -I https://danpearson.net/assets/main-abc123.js | grep Cache-Control
# Expected: Cache-Control: public, max-age=31536000, immutable

# Check no-cache on HTML
curl -I https://danpearson.net/ | grep Cache-Control
# Expected: Cache-Control: public, max-age=0, must-revalidate
```

### 8.4 Health Check Endpoints

Create a simple health check:

```bash
# Test main page loads
curl -s https://danpearson.net | grep -q "Dan Pearson" && echo "✓ Website loaded" || echo "✗ Website failed"

# Test Supabase connection
curl -s https://qazhdcqvjppbbjxzvisp.supabase.co/rest/v1/projects \
  -H "apikey: $VITE_SUPABASE_PUBLISHABLE_KEY" | grep -q "[]" && echo "✓ Supabase OK" || echo "✗ Supabase failed"
```

### 8.5 Post-Deployment Checklist

- [ ] Website loads without errors
- [ ] All pages are accessible
- [ ] Admin login works (if applicable)
- [ ] Supabase database queries work
- [ ] Edge functions respond correctly
- [ ] Images load properly
- [ ] CSS is applied correctly
- [ ] JavaScript is interactive
- [ ] Security headers present
- [ ] CSP not blocking resources
- [ ] Cache headers correct
- [ ] No console errors in browser DevTools
- [ ] Core Web Vitals meet targets
- [ ] Mobile responsiveness works
- [ ] Form submissions work (if any)

---

## 9. Troubleshooting

### 9.1 Build Issues

**Error: `ROLLUP_BINARY_NOT_FOUND` on Cloudflare Pages**

Solution:
```ini
# .npmrc
engine-strict=false
optional=true
```

**Error: `Cannot find module '@/...'`**

Solution:
- Check `tsconfig.json` path aliases are correct
- Verify `@/*` maps to `./src/*`
- Restart TypeScript server in VS Code

**Error: TypeScript errors during build**

```bash
# Check strict mode is not preventing build
npm run lint

# Fix issues
npm run lint -- --fix
```

### 9.2 Deployment Issues

**Cloudflare Pages Build Fails**

Check logs:
1. Go to Cloudflare Pages > Deployments
2. Click failed deployment
3. Check "Build log" tab
4. Common issues:
   - Node.js version mismatch (should be 18+)
   - Missing dependencies
   - Environment variables not set

**Supabase Migrations Fail**

```bash
# Check migration status
supabase db status

# Roll back last migration
supabase db push --dry-run  # See what would happen

# Check for conflicting migrations
supabase db pull  # Pull remote schema
```

### 9.3 Runtime Issues

**404 Errors on Page Refresh**

This means SPA routing isn't working:
1. Verify `_redirects` file exists in public directory
2. Content should be: `/*    /index.html   200`
3. Rebuild and redeploy

**Images Not Loading**

```bash
# Check image URLs in Network tab of DevTools
# Ensure URLs are absolute, not relative
# Example: https://danpearson.net/android-chrome-512x512.png

# Check CSP allows images
curl -I https://danpearson.net | grep Content-Security-Policy
# Should include: img-src 'self' data: https: blob:
```

**Supabase Connection Errors**

```bash
# Verify credentials
echo $VITE_SUPABASE_URL
echo $VITE_SUPABASE_PUBLISHABLE_KEY

# Test connection
curl -I https://qazhdcqvjppbbjxzvisp.supabase.co

# Check firewall rules
# Supabase project settings > API Settings > Enable Realtime
```

**Slow Page Loads**

```bash
# Check bundle sizes
npm run build
ls -lh dist/assets/

# Profile with Lighthouse
# Check for large vendor chunks not being lazy-loaded
# Check Network tab for slow requests
```

### 9.4 Security Issues

**CSP Violations in Console**

```
Refused to load script from 'https://unsafe-domain.com'
```

Solution:
1. Edit `index.html` CSP meta tag
2. Add domain to appropriate directive
3. Example: `script-src 'self' https://unsafe-domain.com`
4. Redeploy

**Auth Errors**

```bash
# Check JWT tokens
# Open DevTools > Application > Cookies
# Look for `sb-access-token` and `sb-refresh-token`

# Test auth endpoint
curl -X POST https://qazhdcqvjppbbjxzvisp.supabase.co/auth/v1/token?grant_type=refresh_token \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"your-token"}'
```

### 9.5 Performance Issues

**High Memory Usage**

Three.js scenes not properly disposed:
1. Check `useEffect` cleanup functions
2. Dispose of geometries and materials
3. Remove event listeners

**Janky Animations**

```bash
# Check DevTools Performance tab
# Look for long tasks (> 50ms)
# Identify and optimize heavy computations
# Consider requestAnimationFrame batching
```

### 9.6 Common Errors and Solutions

| Error | Cause | Solution |
|-------|-------|----------|
| `VITE_SUPABASE_URL is undefined` | Missing .env file | Create .env with values |
| `Cannot access Supabase` | CORS issue | Check CSP connect-src directive |
| `RLS policy violation` | User doesn't have permission | Check table policies and user role |
| `Migration failed` | Conflicting schema | Review migration files, resolve conflicts |
| `Build timeout` | Large bundle | Optimize imports, enable lazy loading |
| `404 on navigation` | SPA routing broken | Check _redirects file exists |
| `Images not loading` | CSP blocking | Add domain to img-src policy |
| `Functions not accessible` | JWT verification | Check verify_jwt setting in config.toml |

---

## Rollback Procedures

### Rollback Frontend Deployment

```bash
# In Cloudflare Pages dashboard
# Deployments tab > Find previous deployment > Rollback

# Or via Wrangler
wrangler pages rollback
```

### Rollback Database Migrations

```bash
# View migration history
supabase db status

# Create reverse migration
supabase migrations create revert_latest

# In generated file, add reverse SQL

# Deploy
supabase db push
```

---

## Security Considerations

### Environment Variables
- Never commit `.env` to version control
- Use `.env.example` for template
- Rotate secrets regularly
- Use unique keys per environment (dev/prod)

### Database Access
- All tables have RLS enabled
- Service role key never exposed to client
- Public key only used for unauthenticated queries
- Admin functions verify JWT tokens

### API Security
- Rate limiting on contact form (3 emails/hour per IP)
- Rate limiting on login attempts (5 attempts/15 min)
- CORS headers restrict cross-origin requests
- CSP prevents inline script injection

### Deployment Security
- No secrets in build logs
- Cloudflare Pages provides DDoS protection
- HTTPS enforced
- HTTP headers prevent clickjacking

---

## Monitoring

### Key Metrics to Monitor

1. **Website Performance**
   - Page load time
   - Core Web Vitals (LCP, FID, CLS)
   - Error rate

2. **API Performance**
   - Function execution time
   - Error rate
   - Success rate

3. **Database**
   - Query performance
   - Connection count
   - Storage usage

4. **Security**
   - Failed auth attempts
   - CSP violations
   - Rate limit hits

### Monitoring Tools

- **Cloudflare Analytics:** Built into dashboard
- **Supabase Monitor:** Project > Monitoring
- **Google Analytics:** Configured in index.html (GA-ID: G-8R95ZXMV6L)
- **Performance Budgets:** Monitor bundle sizes

---

## Support and Resources

- **Vite Docs:** https://vitejs.dev/
- **React Docs:** https://react.dev/
- **Supabase Docs:** https://supabase.com/docs
- **Cloudflare Pages Docs:** https://developers.cloudflare.com/pages/
- **Tailwind CSS Docs:** https://tailwindcss.com/docs

